easyblock = 'ConfigureMake'

name = 'UnZip'
version = '6.0'

homepage = 'http://www.info-zip.org/UnZip.html'
description = """UnZip is an extraction utility for archives compressed
in .zip format (also called "zipfiles"). Although highly compatible both
with PKWARE's PKZIP and PKUNZIP utilities for MS-DOS and with Info-ZIP's
own Zip program, our primary objectives have been portability and
non-MSDOS functionality."""

toolchain = {'name': 'GCCcore', 'version': '8.2.0'}

source_urls = ['ftp://ftp.info-zip.org/pub/infozip/src/']
sources = ['%(namelower)s%(version_major)s%(version_minor)s.tgz']
patches = [
    '01-manpages-in-section-1-not-in-section-1l.patch',
    '03-include-unistd-for-kfreebsd.patch',
    '04-handle-pkware-verification-bit.patch',
    '05-fix-uid-gid-handling.patch',
    '06-initialize-the-symlink-flag.patch',
    '07-increase-size-of-cfactorstr.patch',
    '08-allow-greater-hostver-values.patch',
    '09-cve-2014-8139-crc-overflow.patch',
    '10-cve-2014-8140-test-compr-eb.patch',
    '11-cve-2014-8141-getzip64data.patch',
    '12-cve-2014-9636-test-compr-eb.patch',
    '13-remove-build-date.patch',
    '14-cve-2015-7696.patch',
    '15-cve-2015-7697.patch',
    '16-fix-integer-underflow-csiz-decrypted.patch',
    '20-unzip60-alt-iconv-utf8.patch',
]
checksums = [
    '036d96991646d0449ed0aa952e4fbe21b476ce994abc276e49d30e686708bd37',  # unzip60.tgz
    # 01-manpages-in-section-1-not-in-section-1l.patch
    '96f14ec2e6ea63fe0241361e8361118fdeb4795787541ec4b708a5a196ad7f9a',
    'f530e0b1c99a14fd7df53d2fa9366ad405d9499c3f9ea383329fa7591d2b7ae8',  # 03-include-unistd-for-kfreebsd.patch
    '6829ce345b66d081cb1b8b5be37f092836fbcb71819594e45218fc03d8e80754',  # 04-handle-pkware-verification-bit.patch
    '3650b53a49742d7ffb2c7d5db2ef1cdeaf3d34d21daa976dc7024ceb605a9dee',  # 05-fix-uid-gid-handling.patch
    'b3e1fc3af6ef0e43fd3f3f806e0a155f0f9f1e6cac44251ca16ee046053fb55f',  # 06-initialize-the-symlink-flag.patch
    '8e63dda6e4bea73934756da366bd21f4b59ed4b984e827e7aef590f2dffd066b',  # 07-increase-size-of-cfactorstr.patch
    '3a8cfd2702d220c6c119eaf805b018b66460284e585e92adc8a572d190471724',  # 08-allow-greater-hostver-values.patch
    '9c572a54ed9dce591a4967c4110d74b6281d43ba625412a60dee8c39a43e3b8f',  # 09-cve-2014-8139-crc-overflow.patch
    'cbe4bd38d21fbaebfc54edcc1f110d03ee12e9d5db838609cb26d048e4117a70',  # 10-cve-2014-8140-test-compr-eb.patch
    '9c1188cb121c7c085145601f3d771fc925401ba463cbad04534374fd3c268cfc',  # 11-cve-2014-8141-getzip64data.patch
    '8eaed3e666440912b2806c1d82f95d78220569b9ce44caf9527044e4df0cb2db',  # 12-cve-2014-9636-test-compr-eb.patch
    '06d4e54eb37765d188dfca119d6becfbc38f1236ced1e10aa030d3552738963b',  # 13-remove-build-date.patch
    '788c29727ff0689c3b1828466127758426f6d2c769048aa985950373747c76f3',  # 14-cve-2015-7696.patch
    '9bdea454a3677e00fc81b8ffe534040b2a250ae0d76437d38e41f849997668ae',  # 15-cve-2015-7697.patch
    '95dd15d5d9cdf5cea18c357b152930d6d52660599e0fd4907d6405870fdd9fe1',  # 16-fix-integer-underflow-csiz-decrypted.patch
    'e64c9ddb38c2e7d08bdb80c597f32ee960e18fbe8cb982e444b1ece03ac95cec',  # 20-unzip60-alt-iconv-utf8.patch
]

builddependencies = [
    ('binutils', '2.31.1'),
]

dependencies = [
    ('bzip2', '1.0.6'),
]

skipsteps = ['configure']

buildopts = '-f unix/Makefile D_USE_BZ2=-DUSE_BZIP2 L_BZ2=-lbz2 '
buildopts += 'LF2="$LDFLAGS" '
# Note: CF is multiple lines
buildopts += 'CF="$CFLAGS $CPPFLAGS -I. -DACORN_FTYPE_NFS -DWILD_STOP_AT_DIR -DLARGE_FILE_SUPPORT '
buildopts += '-DUNICODE_SUPPORT -DUNICODE_WCHAR -DUTF8_MAYBE_NATIVE -DNO_LCHMOD '
buildopts += '-DDATE_FORMAT=DF_YMD -DUSE_BZIP2 -DIZ_HAVE_UXUIDGID -DNOMEMCPY -DNO_WORKING_ISPRINT" unzips '

installopts = '-f unix/Makefile prefix=%(installdir)s '

sanity_check_paths = {
    'files': ['bin/unzip', 'bin/zipinfo'],
    'dirs': ['man/man1']
}

moduleclass = 'tools'
