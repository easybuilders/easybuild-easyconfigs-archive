easyblock = 'CMakeMake'

name = 'Kratos'
version = '6.0'
versionsuffix = '-Python-%(pyver)s'

homepage = 'http://www.cimne.com/kratos'
description = """Kratos Multiphysics (A.K.A Kratos) is a framework for building parallel multi-disciplinary
 simulation software."""

toolchain = {'name': 'intel', 'version': '2018a'}
toolchainopts = {'cstd': 'c++11'}

source_urls = ['https://github.com/KratosMultiphysics/Kratos/archive/']
sources = ['v%(version)s.tar.gz']
patches = ['Kratos-%(version)s_fix-install.patch']
checksums = [
    '93effdd248d1624ffb5593e3292d429b4fc07764be2a6f2a64779f2951332b33',  # v6.0.tar.gz
    'b32e0f0b4d05a524d80479d03a3fbefb8da9c393510694853402ae3efb462ad6',  # Kratos-6.0_fix-install.patch
]

builddependencies = [('CMake', '3.12.1')]
dependencies = [
    ('Python', '3.6.4'),
    ('Boost', '1.66.0'),
    ('zlib', '1.2.11'),
]

separate_build_dir = True

# see configure.sh script for default set of configuration options
configopts = "-DCMAKE_BUILD_TYPE=Release -DKRATOS_INSTALL_PREFIX=%(installdir)s -DBOOST_ROOT=$EBROOTBOOST "
configopts += "-DPYTHON_EXECUTABLE=$EBROOTPYTHON/bin/python -DINSTALL_EMBEDDED_PYTHON=ON -DINSTALL_PYTHON_FILES=ON "
configopts += "-DMESHING_APPLICATION=ON -DEXTERNAL_SOLVERS_APPLICATION=ON -DSTRUCTURAL_MECHANICS_APPLICATION=ON "
configopts += "-DCONVECTION_DIFFUSION_APPLICATION=ON -DSOLID_MECHANICS_APPLICATION=ON -DFSI_APPLICATION=ON "
configopts += "-DCONSTITUTIVE_MODELS_APPLICATION=ON -DFLUID_DYNAMICS_APPLICATION=ON -DMESH_MOVING_APPLICATION=ON "
configopts += "-DDEM_APPLICATION=OFF -DSWIMMING_DEM_APPLICATION=OFF -DMIXED_ELEMENT_APPLICATION=OFF "
configopts += "-DSHAPE_OPTIMIZATION_APPLICATION=OFF -DTOPOLOGY_OPTIMIZATION_APPLICATION=OFF "
# -DMETIS_APPLICATION=OFF -DPARMETIS_ROOT_DIR=$EBROOTPARMETIS  # still requires ParMETIS 3.x ?!
# -DTRILINOS_APPLICATION=OFF -DTRILINOS_ROOT=$EBROOTTRILINOS

sanity_check_paths = {
    'files': ['libs/libKratosCore.so', 'runkratos'],
    'dirs': ['applications', 'kratos'],
}

sanity_check_commands = [
    "python -c 'import Kratos'",
    "python -c 'import KratosMultiphysics'",
]

modextrapaths = {
    'LD_LIBRARY_PATH': 'libs',
    'PATH': '',
    'PYTHONPATH': ['', 'libs'],
}

moduleclass = 'phys'
